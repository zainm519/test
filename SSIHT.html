<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Explosion Alarme</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- 🎞️ Assets -->
      <a-assets>
        <a-asset-item id="alar" src="./alarme.glb"></a-asset-item>
        <a-asset-item id="survpas" src="./surveillance_camerapaspied.glb"></a-asset-item>
        <a-asset-item id="surv" src="./surveillance_camerapied.glb"></a-asset-item>
        <img id="salless" src="./sallessihtb.jpg" />
        <audio id="alarmsound" src="./alarme-342932.mp3" preload="auto"></audio>
      </a-assets>

      <!-- 🌌 Ciel -->
      <a-sky src="#salless"></a-sky>

      <!-- 🎥 Caméra du joueur -->
      <a-entity camera position="0 1.6 0" look-controls>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
      </a-entity>

      <!-- 🎥 Caméras de surveillance -->
    <a-entity id="surv" gltf-model="./surveillance_camerapied.glb" position="-31.71937 19.99428 49.34695" scale="15 15 15" rotation="-17.79721503235363 -33.493393829962535 11.105067985225615">
      </a-entity>

     <a-entity id="survpas" gltf-model="./surveillance_camerapaspied.glb" position="-4.74865 3.94615 7.22221" scale="2.5 2.5 2.5" rotation="17.391560913401012 147.23067278358712 -1.1287268564077217">
      </a-entity>

      <!-- 🔔 Alarme -->
      <a-entity id="alarme"
                gltf-model="#alar"
                position="-13.79992 -30.02283 22.72893"
                scale="13 13 13"
                rotation="0 120 0"
                class="clickable"
                sound="src: #alarmsound; autoplay: false; volume: 2">
      </a-entity>
    </a-scene>

    <script>
      const alarm = document.querySelector('#alarme');

      alarm.addEventListener('click', () => {
        if (alarm.classList.contains('triggered')) return; // éviter double clic
        alarm.classList.add('triggered');

        // 🔊 Jouer le son
        alarm.components.sound.playSound();

        // 🔥 Ajouter effet feu : lumière + flamme
        const flameLight = document.createElement('a-entity');
        flameLight.setAttribute('light', 'type: point; intensity: 2.0; color: orange; distance: 10; decay: 2');
        flameLight.setAttribute('position', '0 3 0');
        alarm.appendChild(flameLight);

        const flame = document.createElement('a-sphere');
        flame.setAttribute('position', '0 3 0');
        flame.setAttribute('radius', '1.5');
        flame.setAttribute('material', 'color: orange; emissive: red; opacity: 0.6; transparent: true');
        flame.setAttribute('animation', 'property: scale; to: 1.3 1.5 1.3; dir: alternate; dur: 200; loop: true');
        alarm.appendChild(flame);

        // 💥 Explosion après 3 secondes
        setTimeout(() => {
          flame.remove();
          flameLight.remove();
          alarm.setAttribute('visible', 'false');
          triggerExplosion(alarm.object3D.position);
        }, 3000);
      });

      function triggerExplosion(pos3D) {
        const scene = document.querySelector('a-scene');

        // 🔽 Position de l'explosion plus basse
        const pos = {
          x: pos3D.x,
          y: pos3D.y - 10,
          z: pos3D.z
        };

        // 💣 Boule d'explosion
        const blast = document.createElement('a-sphere');
        blast.setAttribute('position', pos);
        blast.setAttribute('radius', '2');
        blast.setAttribute('material', 'color: orange; emissive: red; opacity: 0.9; transparent: true');
        blast.setAttribute('animation__scale', 'property: scale; to: 15 15 15; dur: 500; easing: easeOutQuad');
        blast.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 600; delay: 200');
        scene.appendChild(blast);

        setTimeout(() => {
          blast.remove();
        }, 1200);

        // 🧱 Débris
        for (let i = 0; i < 10; i++) {
          const debris = document.createElement('a-box');
          debris.setAttribute('position', `${pos.x} ${pos.y + 5} ${pos.z}`);
          debris.setAttribute('width', '1');
          debris.setAttribute('height', '1');
          debris.setAttribute('depth', '1');
          debris.setAttribute('material', 'color: gray; opacity: 1');

          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 10 + 2;
          const vx = Math.cos(angle) * speed;
          const vz = Math.sin(angle) * speed;
          const vy = Math.random() * 10;

          const targetX = pos.x + vx;
          const targetY = pos.y + 5 + vy;
          const targetZ = pos.z + vz;

          debris.setAttribute('animation__move', `property: position; to: ${targetX} ${targetY} ${targetZ}; dur: 1000`);
          debris.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 800; delay: 300');

          scene.appendChild(debris);

          setTimeout(() => debris.remove(), 1500);
        }
      }
    </script>
  </body>
</html>
