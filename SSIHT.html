<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Salle SSIHT</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- 🎞️ Assets -->
      <a-assets>
        <video id="flux-video" autoplay="false" loop="true" muted src="Flux-Video.mp4"></video>
        <video id="video-survpas" autoplay="false" loop="true" src="ALCE5581.mp4"></video>
        <a-asset-item id="bouton" src="bouton-camera.obj"></a-asset-item>
        <a-asset-item id="butin" src="bout.obj"></a-asset-item>
        <img id="ssalless" src="ssallessihtb.jpg" /> 
        <a-asset-item id="mini" src="orange_safe_zone_minitel_phone.glb"></a-asset-item>
        <a-asset-item id="key" src="keyboard.glb"></a-asset-item>
        <a-asset-item id="alar" src="alarme.glb"></a-asset-item>
        <a-asset-item id="survpas" src="surveillance_camerapaspied.glb"></a-asset-item>
        <a-asset-item id="surv" src="surveillance_camerapied.glb"></a-asset-item>
        <img id="offline-img" src="OFFLINE.jpg" />
        <audio id="alarmsound" src="alarme-342932.mp3" preload="auto"></audio>
        <video id="shidou" class="clickable" autoplay loop="true" src="ALCE5581.mp4"></video>
      </a-assets>

      <!-- 🔴 Bouton principal -->
      <a-obj-model 
        id="videoButton" 
        class="clickable"
        src="#butin" 
        position="-12.71124 -19.40063 19.98393" 
        material="color: #ff0000"
        rotation="-90.87416 175.99985 175.99985"
        scale="0.03495522870314175 0.03495522870314175 0.03495522870314175">
      </a-obj-model>
      
      <!-- 💗 Bouton rose (ALCE5581) -->
      <a-obj-model 
        id="boutonRose"
        class="clickable"
        src="#bouton"
        position="-19.42891 -19.40063 24.85667"
        material="color: #ff80c0"
        rotation="-89.87416 179.99985 179.99985"
        scale="0.03 0.03 0.03">
      </a-obj-model>

      <!-- 📟 MINI -->
      <a-entity id="miniEntity" 
        gltf-model="orange_safe_zone_minitel_phone.glb"
        position="7.85511 -0.25866 0.17654"
        rotation="0 -92.47767 0"
        scale="0.8 0.8 0.8">
      </a-entity>

      <!-- ⌨️ CLAVIER -->
      <a-entity id="keyEntity"
        gltf-model="keyboard.glb"
        position="17.25583 -12.67706 6.21092"
        rotation="-0.016 -163.032 -0.002"
        scale="1.33483 1.2 1.2"
        class="clickable">
      </a-entity>
      
      <!-- 🎬 Écran principal -->
      <a-video
        id="videoScreen"
        src="#flux-video"
        width="16"
        height="9"
        position="-2.2995 -5.90513 8.79376"
        rotation="0.32945 -174.604 5.9679"
        scale="0.22282 0.22972 1">
      </a-video>

      <!-- 🖼️ Image OFFLINE -->
      <a-image
        id="offlineImage"
        src="#offline-img"
        width="16"
        height="9"
        position="-2.2995 -5.90513 8.79376"
        rotation="0.32945 -174.604 5.9679"
        scale="0.22282 0.22972 1"
        visible="false">
      </a-image>

      <!-- 🎬 Écran secondaire -->
      <a-video 
        id="videoScreen2" 
        src="#video-survpas"
        width="16"
        height="9"
        position="-12.24911 -5.5989 11.86178"
        rotation="5.09875 179.9511 1.70397"
        scale="0.2225 0.22086 1">
      </a-video>

     
      <!-- 🌌 Ciel -->
      <a-sky src="#ssalless"></a-sky> 
      
      
      <!-- 🎥 Caméra joueur -->
      <a-entity camera position="0 1.6 0" look-controls>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
      </a-entity>

      <!-- 🎥 Caméras de surveillance -->
      <a-entity 
        id="surv" 
        gltf-model="#surv" 
        position="-31.71937 19.99428 49.34695"
        scale="15 15 15" 
        rotation="-17.79 -33.49 11.10">
      </a-entity>

      <a-entity id="survpas"
        gltf-model="surveillance_camerapaspied.glb"
        position="-4.22447 3.56613 6.53982"
        scale="2.5 2.5 2.5"
        rotation="17.39 156.08337802410762 -1.12"
        animation="dir: alternate; dur: 2000; easing: easeInOutSine; loop: true; property: rotation; to: 17.39 167.23 -1.12">
      </a-entity>
        
      <!-- 🔔 Alarme -->
      <a-entity 
        id="alarme" 
        gltf-model="#alar"
        position="-13.79992 -30.02283 22.72893"
        scale="13 13 13" 
        rotation="0 120 0"
        class="clickable" 
        sound="src: #alarmsound; autoplay: false; volume: 2">
      </a-entity>
    </a-scene>

    <script>
      /* -------------------
         🎬 CONTROLE BOUTONS
      -------------------- */
      const video = document.querySelector('#flux-video');
      const videoButton = document.querySelector('#videoButton');
      const offlineImage = document.querySelector('#offlineImage');
      let isOffline = false;

      videoButton.addEventListener('click', () => {
        isOffline = !isOffline;
        const surv = document.querySelector('#surv');
        const survpas = document.querySelector('#survpas');

        if (isOffline) {
          offlineImage.setAttribute('visible', true);
          video.pause();
          videoButton.setAttribute('material', 'color: #ff0000');
          stopAnimation(surv);
          stopAnimation(survpas);
        } else {
          offlineImage.setAttribute('visible', false);
          video.play();
          videoButton.setAttribute('material', 'color: green');
          surv.setAttribute('animation','property: rotation; dir: alternate; dur: 2500; easing: easeInOutSine; to: -17.79 -53.49 11.10; loop: true');
          survpas.setAttribute('animation','property: rotation; dir: alternate; dur: 2000; easing: easeInOutSine; to: 17.39 167.23 -1.12; loop: true');
        }
      });

      function stopAnimation(el) {
        if (!el) return;
        const rot = el.getAttribute('rotation');
        el.removeAttribute('animation');
        el.setAttribute('rotation', `${rot.x} ${rot.y} ${rot.z}`);
      }

      /* -------------------
         💗 BOUTON ROSE VIDÉO
      -------------------- */
      const boutonRose = document.querySelector('#boutonRose');
      const videoALCE = document.querySelector('#video-survpas');
      const videoScreenALCE = document.querySelector('#videoScreen2');
      boutonRose.addEventListener('click', () => {
        if (videoALCE.paused) {
          videoScreenALCE.setAttribute('visible', true);
          boutonRose.setAttribute('material', 'color: #00ff80');
          videoALCE.muted = false;
          videoALCE.play().catch(() => { videoALCE.muted = true; videoALCE.play(); });
        } else {
          videoALCE.pause();
          videoScreenALCE.setAttribute('visible', false);
          boutonRose.setAttribute('material', 'color: #ff80c0');
          videoALCE.muted = true;
        }
      });

      /* -------------------
         🔔 ALARME
      -------------------- */
      const alarm = document.querySelector('#alarme');
      const ACTIVE_TINT = 0xff7700;
      alarm._originalMaterials = null;

      alarm.addEventListener('model-loaded', () => saveOriginalMaterials());
      function saveOriginalMaterials() {
        const root = alarm.getObject3D('mesh');
        if (!root) return;
        const originals = [];
        root.traverse(node => {
          if (node.isMesh) {
            const mat = node.material;
            originals.push({ uuid: node.uuid, material: Array.isArray(mat) ? mat.map(m => m.clone()) : mat.clone() });
          }
        });
        alarm._originalMaterials = originals;
      }
      function tintAlarm(color) {
        const root = alarm.getObject3D('mesh');
        if (!root) return;
        root.traverse(node => {
          if (node.isMesh) {
            const mats = Array.isArray(node.material) ? node.material : [node.material];
            mats.forEach(m => { if (m.color) m.color.set(color); if (m.emissive) m.emissive.set(color); });
          }
        });
      }
      function restoreOriginalMaterials() {
        const root = alarm.getObject3D('mesh');
        if (!root || !alarm._originalMaterials) return;
        root.traverse(node => {
          if (node.isMesh) {
            const orig = alarm._originalMaterials.find(o => o.uuid === node.uuid);
            if (orig) node.material = orig.material;
          }
        });
      }
      alarm.addEventListener('click', () => {
        if (alarm.classList.contains('triggered')) return;
        alarm.classList.add('triggered');
        if (!alarm._originalMaterials) saveOriginalMaterials();
        tintAlarm(ACTIVE_TINT);
        if (alarm.components && alarm.components.sound) alarm.components.sound.playSound();

        const flameLight = document.createElement('a-entity');
        flameLight.setAttribute('light', 'type: point; intensity: 2.0; color: orange; distance: 10; decay: 2');
        flameLight.setAttribute('position', '0 3 0');
        alarm.appendChild(flameLight);

        const flame = document.createElement('a-sphere');
        flame.setAttribute('position', '0 3 0');
        flame.setAttribute('radius', '1.5');
        flame.setAttribute('material', 'color: orange; emissive: red; opacity: 0.6; transparent: true');
        flame.setAttribute('animation', 'property: scale; to: 1.3 1.5 1.3; dir: alternate; dur: 200; loop: true');
        alarm.appendChild(flame);

        setTimeout(() => {
          flame.remove();
          flameLight.remove();
          restoreOriginalMaterials();
          alarm.classList.remove('triggered');
        }, 3000);
      });

      /* -------------------
         ⚔️ CLAVIER SHONEN MANGA
      -------------------- */
      (function() {
        const key = document.querySelector('#keyEntity');
        if (!key) return;

        const ATTACKS = [
          "技 : データ斬り！ (Data Slash!) ⚡",
          "技 : 雷撃拳！ (Raigeki Fist!) ⚡",
          "技 : 連撃 (Rengeki) ×3！ 💥",
          "必殺技 : サイバー拳！ (Cyber Punch!) 💥",
          "必殺奥義 : 虚空断 (Void Break) — 一撃必殺！"
        ];
        const MAX_ATTACKS = ATTACKS.length;
        let attackIndex = 0;
        let locked = false;
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        function ensureAudio() {
          if (!audioCtx) audioCtx = new AudioCtx();
        }
        function playAttackSound(type = 0) {
          ensureAudio();
          const now = audioCtx.currentTime;
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = type % 2 === 0 ? 'sawtooth' : 'square';
          osc.frequency.setValueAtTime(220 + type * 120, now);
          gain.gain.setValueAtTime(0, now);
          gain.gain.linearRampToValueAtTime(0.4, now + 0.01);
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.35);
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start(now);
          osc.stop(now + 0.35);
        }
        function createEntity(tag, attrs = {}, parent = key) {
          const el = document.createElement(tag);
          Object.keys(attrs).forEach(k => el.setAttribute(k, attrs[k]));
          parent.appendChild(el);
          return el;
        }
        function doAttack(textStr, idx) {
          if (locked) return;
          locked = true;
          key.setAttribute('animation__shake', 'property: position; from: 0 0 0; to: 0.05 0.05 0; dur: 100; dir: alternate; loop: 4');
          key.setAttribute('animation__flashcolour', 'property: material.color; from: #fff; to: #ff8c00; dur: 120; dir: alternate; loop: 2');

          const
