<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Alarme en feu</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- Assets -->
      <a-assets>
        <a-asset-item id="came" src="./caméra_cctv_low-poly.glb"></a-asset-item>
        <a-asset-item id="surv" src="./surveillance_camera.glb"></a-asset-item>
        <a-asset-item id="alar" src="./alarme.glb"></a-asset-item>
        <img id="salless" src="./sallessihtb.jpg" />
      </a-assets>

      <!-- Ciel -->
      <a-sky src="#salless"></a-sky>

      <!-- Caméra -->
      <a-entity camera position="0 1.6 0" look-controls>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
      </a-entity>

      <!-- Caméra de surveillance -->
      <a-entity gltf-model="#came" position="0 1 -3" scale="0.5 0.5 0.5"></a-entity>
      <a-entity gltf-model="#surv" position="-13.8 6.88047 13.41928" scale="5 5 5" rotation="19.846 140.141 -15.825"></a-entity>

      <!-- Alarme cliquable -->
      <a-entity id="alarme"
                gltf-model="#alar"
                position="-13.79992 -30.02283 22.72893"
                scale="13 13 13"
                rotation="0 120 0"
                class="clickable">
      </a-entity>
    </a-scene>

    <script>
      const alarm = document.querySelector('#alarme');

      alarm.addEventListener('click', () => {
        if (alarm.classList.contains('triggered')) return;
        alarm.classList.add('triggered');

        // 1) Animation de feu : changement de couleur et d’émissivité
        alarm.setAttribute('animation__color', {
          property: 'material.color',
          to: '#ff4500',
          dur: 300,
          dir: 'alternate',
          loop: true
        });
        alarm.setAttribute('animation__emissive', {
          property: 'material.emissive',
          to: '#ff0000',
          dur: 300,
          dir: 'alternate',
          loop: true
        });

        // 2) Après 3 secondes : explosion
        setTimeout(() => {
          // Supprimer les animations
          alarm.removeAttribute('animation__color');
          alarm.removeAttribute('animation__emissive');

          // Cacher le modèle
          alarm.setAttribute('visible', 'false');

          // Explosion visuelle
          triggerExplosion(alarm);
        }, 3000);
      });

      function triggerExplosion(sourceEntity) {
        const scene = document.querySelector('a-scene');
        const pos = sourceEntity.getAttribute('position');

        // Boule d’explosion
        const blast = document.createElement('a-sphere');
        blast.setAttribute('position', pos);
        blast.setAttribute('radius', 0.5);
        blast.setAttribute('material', 'color: orange; emissive: red; opacity: 0.9; transparent: true');
        blast.setAttribute('animation__scale', 'property: scale; to: 8 8 8; dur: 600; easing: easeOutQuad');
        blast.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 600; delay: 200');
        scene.appendChild(blast);

        setTimeout(() => {
          blast.remove();
        }, 1200);

        // Débris
        const debrisCount = 10;
        for (let i = 0; i < debrisCount; i++) {
          const box = document.createElement('a-box');
          const offsetY = pos.y + 1;
          box.setAttribute('position', `${pos.x} ${offsetY} ${pos.z}`);
          box.setAttribute('width', '0.1');
          box.setAttribute('height', '0.1');
          box.setAttribute('depth', '0.1');
          box.setAttribute('material', 'color: gray; opacity: 1; metalness: 0.5');

          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 1.5 + 0.5;
          const vx = Math.cos(angle) * speed;
          const vz = Math.sin(angle) * speed;
          const vy = Math.random() * 2;

          const targetX = pos.x + vx;
          const targetY = offsetY + vy;
          const targetZ = pos.z + vz;

          box.setAttribute('animation__move', `property: position; to: ${targetX} ${targetY} ${targetZ}; dur: 1000; easing: easeOutCubic`);
          box.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 900; delay: 200');

          scene.appendChild(box);

          setTimeout(() => {
            box.remove();
          }, 1400);
        }
      }
    </script>
  </body>
</html>
