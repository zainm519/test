<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Salle SSIHT</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- 🎞️ Assets -->
      <a-assets>
        <video id="flux-video" autoplay="false" loop="true" muted src="Flux-Video.mp4"></video>
        <video id="video-survpas" autoplay="false" loop="true" muted src="./ALCE5581.mp4"></video>
        <a-asset-item id="bouton" src="./bouton-camera.obj"></a-asset-item>
        <a-asset-item id="alar" src="./alarme.glb"></a-asset-item>
        <a-asset-item id="survpas" src="./surveillance_camerapaspied.glb"></a-asset-item>
        <a-asset-item id="surv" src="./surveillance_camerapied.glb"></a-asset-item>
        <img id="salless" src="./sallessihtb.jpg" />
        <audio id="alarmsound" src="./alarme-342932.mp3" preload="auto"></audio>
      </a-assets>
<a-obj-model src="#bouton" position="-9.52687 -19.40063 19.98393" material="color: #ff0000" rotation="-89.87415974422093 179.9998479605043 179.9998479605043" scale="0.03 0.03 0.03"></a-obj-model>
      <!-- 🎬 Écran vidéo principal -->
      <a-box
        id="videoBox"
        class="clickable"
        position="-2.3 -5.9 8.5"
        rotation="0.33 -174.6 5.96"
        depth="0.1"
        height="5"
        width="9"
        color="#4CC3D9"
        scale="0.41698 0.30914 0.73785">
      </a-box>

      <a-video
        id="videoScreen"
        src="#flux-video"
        width="16"
        height="9"
        position="-2.2995 -5.90513 8.79376"
        rotation="0.32945 -174.604 5.9679"
        scale="0.22282 0.22972 1"
      ></a-video>

      <!-- 🎬 Second écran vidéo (collé à droite du premier) -->
      <a-video
        id="videoScreen2"
        src="#video-survpas"
        width="16"
        height="9"
        position="1.5 -5.90513 8.79376"
        rotation="0.32945 -174.604 5.9679"
        scale="0.22282 0.22972 1"
        visible="false"
      ></a-video>

      <!-- 🌌 Ciel -->
      <a-sky src="#salless"></a-sky>

      <!-- 🎥 Caméra du joueur -->
      <a-entity camera position="0 1.6 0" look-controls>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
      </a-entity>

      <!-- 🎥 Caméras -->
      <a-entity
        id="surv"
        gltf-model="#surv"
        position="-31.71937 19.99428 49.34695"
        scale="15 15 15"
        rotation="-17.79 -33.49 11.10"
      ></a-entity>

      <a-entity
        id="survpas"
        gltf-model="#survpas"
        position="-4.74865 3.94615 7.22221"
        scale="2.5 2.5 2.5"
        rotation="17.39 147.23 -1.12"
        animation="property: rotation; dir: alternate; dur: 2500; easing: easeInOutSine; to: 17.39 167.23 -1.12; loop: true"
      ></a-entity>

      <!-- 🔔 Alarme -->
      <a-entity
        id="alarme"
        gltf-model="#alar"
        position="-13.79992 -30.02283 22.72893"
        scale="13 13 13"
        rotation="0 120 0"
        class="clickable"
        sound="src: #alarmsound; autoplay: false; volume: 2"
      ></a-entity>
    </a-scene>

    <script>
      // --- Gestion de la vidéo principale ---
      const video = document.querySelector('#flux-video');
      const videoBox = document.querySelector('#videoBox');

      videoBox.addEventListener('click', () => {
        if (video.paused) {
          video.play();
          videoBox.setAttribute('color', 'green');
        } else {
          video.pause();
          videoBox.setAttribute('color', '#4CC3D9');
        }
      });

      // --- Gestion de la vidéo de survpas ---
      const survpas = document.querySelector('#survpas');
      const videoSurvpas = document.querySelector('#video-survpas');
      const videoScreen2 = document.querySelector('#videoScreen2');

      // Charger la vidéo dès le début pour éviter les blocages
      videoSurvpas.load();

      survpas.addEventListener('click', () => {
        const isVisible = videoScreen2.getAttribute('visible');
        if (!isVisible) {
          videoScreen2.setAttribute('visible', true);

          // Tentative de lecture sécurisée
          const playPromise = videoSurvpas.play();
          if (playPromise !== undefined) {
            playPromise.catch(err => {
              console.warn('Lecture automatique bloquée, tentative forcée :', err);
              videoSurvpas.muted = true;
              videoSurvpas.play();
            });
          }
        } else {
          videoSurvpas.pause();
          videoScreen2.setAttribute('visible', false);
        }
      });

      // --- Gestion de l'alarme ---
      const alarm = document.querySelector('#alarme');
      const ACTIVE_TINT = 0xff7700;
      alarm._originalMaterials = null;

      alarm.addEventListener('model-loaded', () => {
        saveOriginalMaterials();
      });

      function saveOriginalMaterials() {
        const root = alarm.getObject3D('mesh');
        if (!root) return;
        const originals = [];
        root.traverse(node => {
          if (node.isMesh) {
            const mat = node.material;
            if (Array.isArray(mat)) {
              originals.push({ uuid: node.uuid, material: mat.map(m => m.clone()) });
            } else {
              originals.push({ uuid: node.uuid, material: mat.clone() });
            }
          }
        });
        alarm._originalMaterials = originals;
      }

      function tintAlarm(color) {
        const root = alarm.getObject3D('mesh');
        if (!root) return;
        root.traverse(node => {
          if (node.isMesh) {
            const mats = node.material;
            if (Array.isArray(mats)) {
              mats.forEach(m => {
                if (m.color) m.color.set(color);
                if (m.emissive) m.emissive.set(color);
              });
            } else {
              if (mats.color) mats.color.set(color);
              if (mats.emissive) mats.emissive.set(color);
            }
            node.material.needsUpdate = true;
          }
        });
      }

      function restoreOriginalMaterials() {
        const root = alarm.getObject3D('mesh');
        if (!root || !alarm._originalMaterials) return;
        root.traverse(node => {
          if (node.isMesh) {
            const orig = alarm._originalMaterials.find(o => o.uuid === node.uuid);
            if (orig) {
              if (Array.isArray(orig.material)) {
                node.material = orig.material.map(m => m.clone());
              } else {
                node.material = orig.material.clone();
              }
              node.material.needsUpdate = true;
            }
          }
        });
      }

      alarm.addEventListener('click', () => {
        if (alarm.classList.contains('triggered')) return;
        alarm.classList.add('triggered');

        if (!alarm._originalMaterials) saveOriginalMaterials();

        tintAlarm(ACTIVE_TINT);

        if (alarm.components && alarm.components.sound) {
          alarm.components.sound.playSound();
        }

        const flameLight = document.createElement('a-entity');
        flameLight.setAttribute(
          'light',
          'type: point; intensity: 2.0; color: orange; distance: 10; decay: 2'
        );
        flameLight.setAttribute('position', '0 3 0');
        alarm.appendChild(flameLight);

        const flame = document.createElement('a-sphere');
        flame.setAttribute('position', '0 3 0');
        flame.setAttribute('radius', '1.5');
        flame.setAttribute(
          'material',
          'color: orange; emissive: red; opacity: 0.6; transparent: true'
        );
        flame.setAttribute(
          'animation',
          'property: scale; to: 1.3 1.5 1.3; dir: alternate; dur: 200; loop: true'
        );
        alarm.appendChild(flame);

        setTimeout(() => {
          flame.remove();
          flameLight.remove();
          triggerExplosion(alarm.object3D.position);

          setTimeout(() => {
            restoreOriginalMaterials();
            alarm.classList.remove('triggered');
          }, 1600);
        }, 3000);
      });

      function triggerExplosion(pos3D) {
        const scene = document.querySelector('a-scene');
        const pos = { x: pos3D.x, y: pos3D.y - 10, z: pos3D.z };

        const blast = document.createElement('a-sphere');
        blast.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
        blast.setAttribute('radius', '2');
        blast.setAttribute(
          'material',
          'color: orange; emissive: red; opacity: 0.9; transparent: true'
        );
        blast.setAttribute(
          'animation__scale',
          'property: scale; to: 15 15 15; dur: 500; easing: easeOutQuad'
        );
        blast.setAttribute(
          'animation__fade',
          'property: material.opacity; to: 0; dur: 600; delay: 200'
        );
        scene.appendChild(blast);
        setTimeout(() => blast.remove(), 1200);

        for (let i = 0; i < 10; i++) {
          const debris = document.createElement('a-box');
          debris.setAttribute('position', `${pos.x} ${pos.y + 5} ${pos.z}`);
          debris.setAttribute('width', '1');
          debris.setAttribute('height', '1');
          debris.setAttribute('depth', '1');
          debris.setAttribute('material', 'color: gray; opacity: 1');

          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 10 + 2;
          const vx = Math.cos(angle) * speed;
          const vz = Math.sin(angle) * speed;
          const vy = Math.random() * 10;

          const targetX = pos.x + vx;
          const targetY = pos.y + 5 + vy;
          const targetZ = pos.z + vz;

          debris.setAttribute(
            'animation__move',
            `property: position; to: ${targetX} ${targetY} ${targetZ}; dur: 1000`
          );
          debris.setAttribute(
            'animation__fade',
            'property: material.opacity; to: 0; dur: 800; delay: 300'
          );

          scene.appendChild(debris);
          setTimeout(() => debris.remove(), 1500);
        }
      }
    </script>
  </body>
</html>
