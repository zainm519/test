<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Alarme Réinitialisable avec Indicateur Lumineux</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- 🎞️ Assets -->
      <a-assets>
        <a-asset-item id="alar" src="./alarme.glb"></a-asset-item>
        <a-asset-item id="survpas" src="./surveillance_camerapaspied.glb"></a-asset-item>
        <a-asset-item id="surv" src="./surveillance_camerapied.glb"></a-asset-item>
        <img id="salless" src="./sallessihtb.jpg" />
        <audio id="alarmsound" src="./alarme-342932.mp3" preload="auto"></audio>
      </a-assets>

      <!-- 🌌 Ciel -->
      <a-sky src="#salless"></a-sky>

      <!-- 🎥 Caméra du joueur -->
      <a-entity camera position="0 1.6 0" look-controls>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
      </a-entity>

      <!-- 🎥 Caméras de surveillance -->
      <a-entity
        id="surv"
        gltf-model="#surv"
        position="-31.71937 19.99428 49.34695"
        scale="15 15 15"
        rotation="-17.79 -33.49 11.10"
      ></a-entity>

      <a-entity
        id="survpas"
        gltf-model="#survpas"
        position="-31.71937 19.99428 49.34695"
        scale="15 15 15"
        rotation="-17.79 -33.49 11.10"
      ></a-entity>

      <!-- 🔔 Alarme avec voyant -->
      <a-entity
        id="alarme"
        gltf-model="#alar"
        position="-13.79992 -30.02283 22.72893"
        scale="13 13 13"
        rotation="0 120 0"
        class="clickable"
        sound="src: #alarmsound; autoplay: false; volume: 2"
      >
        <!-- 💡 voyant coloré (rouge d’origine) -->
        <a-sphere
          id="voyant"
          position="0 4 0"
          radius="0.5"
          material="color: red; emissive: red; emissiveIntensity: 0.4"
        ></a-sphere>
      </a-entity>
    </a-scene>

    <script>
      const alarm = document.querySelector('#alarme');
      const voyant = document.querySelector('#voyant');

      alarm.addEventListener('click', () => {
        // empêcher double clic
        if (alarm.classList.contains('triggered')) return;
        alarm.classList.add('triggered');

        // 🟠 couleur active
        voyant.setAttribute(
          'material',
          'color: orange; emissive: orange; emissiveIntensity: 1'
        );

        // 🔊 jouer le son
        alarm.components.sound.playSound();

        // 🔥 flamme + lumière
        const flameLight = document.createElement('a-entity');
        flameLight.setAttribute(
          'light',
          'type: point; intensity: 2.0; color: orange; distance: 10; decay: 2'
        );
        flameLight.setAttribute('position', '0 3 0');
        alarm.appendChild(flameLight);

        const flame = document.createElement('a-sphere');
        flame.setAttribute('position', '0 3 0');
        flame.setAttribute('radius', '1.5');
        flame.setAttribute(
          'material',
          'color: orange; emissive: red; opacity: 0.6; transparent: true'
        );
        flame.setAttribute(
          'animation',
          'property: scale; to: 1.3 1.5 1.3; dir: alternate; dur: 200; loop: true'
        );
        alarm.appendChild(flame);

        // 💥 explosion après 3 secondes
        setTimeout(() => {
          flame.remove();
          flameLight.remove();
          triggerExplosion(alarm.object3D.position);

          // ♻️ après explosion : voyant rouge + re-cliquable
          setTimeout(() => {
            voyant.setAttribute(
              'material',
              'color: red; emissive: red; emissiveIntensity: 0.4'
            );
            alarm.classList.remove('triggered');
          }, 1500);
        }, 3000);
      });

      function triggerExplosion(pos3D) {
        const scene = document.querySelector('a-scene');

        // position légèrement plus basse
        const pos = {
          x: pos3D.x,
          y: pos3D.y - 10,
          z: pos3D.z
        };

        // 💣 boule d'explosion
        const blast = document.createElement('a-sphere');
        blast.setAttribute('position', pos);
        blast.setAttribute('radius', '2');
        blast.setAttribute(
          'material',
          'color: orange; emissive: red; opacity: 0.9; transparent: true'
        );
        blast.setAttribute(
          'animation__scale',
          'property: scale; to: 15 15 15; dur: 500; easing: easeOutQuad'
        );
        blast.setAttribute(
          'animation__fade',
          'property: material.opacity; to: 0; dur: 600; delay: 200'
        );
        scene.appendChild(blast);

        setTimeout(() => blast.remove(), 1200);

        // 🧱 débris
        for (let i = 0; i < 10; i++) {
          const debris = document.createElement('a-box');
          debris.setAttribute('position', `${pos.x} ${pos.y + 5} ${pos.z}`);
          debris.setAttribute('width', '1');
          debris.setAttribute('height', '1');
          debris.setAttribute('depth', '1');
          debris.setAttribute('material', 'color: gray; opacity: 1');

          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 10 + 2;
          const vx = Math.cos(angle) * speed;
          const vz = Math.sin(angle) * speed;
          const vy = Math.random() * 10;

          const targetX = pos.x + vx;
          const targetY = pos.y + 5 + vy;
          const targetZ = pos.z + vz;

          debris.setAttribute(
            'animation__move',
            `property: position; to: ${targetX} ${targetY} ${targetZ}; dur: 1000`
          );
          debris.setAttribute(
            'animation__fade',
            'property: material.opacity; to: 0; dur: 800; delay: 300'
          );

          scene.appendChild(debris);

          setTimeout(() => debris.remove(), 1500);
        }
      }
    </script>
  </body>
</html>
